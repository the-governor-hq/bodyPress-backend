# fly.toml — Fly.io app configuration
# https://fly.io/docs/reference/configuration/
#

app            = "bodypress-backend"
primary_region = "iad"

[build]

[env]
  PORT     = "4000"
  NODE_ENV = "production"

# ── Processes ─────────────────────────────────────────────────────────────────
# Two process groups share the same Docker image.
# Scale them independently with: fly scale count api=N worker=N
[processes]
  api    = "node dist/server.js"
  worker = "node dist/worker.js"

# ── HTTP service (api process only) ───────────────────────────────────────────
[http_service]
  processes           = ["api"]
  internal_port       = 4000
  force_https         = true
  auto_stop_machines  = "stop"
  auto_start_machines = true
  min_machines_running = 1

  [http_service.concurrency]
    type       = "connections"
    hard_limit = 200
    soft_limit = 150

  [[http_service.checks]]
    grace_period = "10s"
    interval     = "15s"
    method       = "GET"
    path         = "/healthz"
    timeout      = "5s"

# ── VM sizing ─────────────────────────────────────────────────────────────────
[[vm]]
  processes = ["api"]
  cpu_kind  = "shared"
  cpus      = 1
  memory    = "512mb"

[[vm]]
  processes = ["worker"]
  cpu_kind  = "shared"
  cpus      = 1
  memory    = "256mb"

# ── Release command (runs before new machines become live) ────────────────────
[deploy]
  release_command = "npx prisma migrate deploy"
